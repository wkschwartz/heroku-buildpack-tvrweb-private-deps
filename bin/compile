#! /bin/bash

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

mkdir -p $HOME/vendor
cd $HOME/vendor

if [ ! -d tvrepack ]; then
	echo "-----> Downloading TVRepack"
	git clone https://${GITHUB_OAUTH_TOKEN}:x-oauth-basic@github.com/EconomistsInc/tvrepack >/dev/null 2>&1
else
	echo "-----> TVRepack already downloaded, not sure why"
	exit 1
fi

# We remove the repo's .git because the OAuth token will have been written in
# .git/config during the clone step.
echo "-----> Removing TVRepack repo metdata"
cd tvrepack
rm -rf .git

echo "-----> Adding TVRepack to the PYTHONPATH"
cd $HOME
mkdir -p .profile.d
cd .profile.d
echo 'export PYTHONPATH=$PYTHONPATH:$HOME/vendor/tvrepack' > tvrepack.sh


echo "-----> Done"
