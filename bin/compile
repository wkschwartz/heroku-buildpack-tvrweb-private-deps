#! /bin/bash

# Usage:
#
#     $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

echo "-----> Downloading TVRepack"
mkdir -p $BUILD_DIR/vendor
git clone $BUILD_DIR/vendor/tvrepack https://${GITHUB_OAUTH_TOKEN}:x-oauth-basic@github.com/EconomistsInc/tvrepack >/dev/null 2>&1

# We remove the repo's .git because the OAuth token will have been written in
# .git/config during the clone step.
echo "-----> Removing TVRepack repo metdata"
rm -rf $BUILD_DIR/vendor/tvrepack/.git

echo "-----> Adding TVRepack to the PYTHONPATH"
mkdir -p $BUILD_DIR/.profile.d
echo 'export PYTHONPATH=$PYTHONPATH:$HOME/vendor/tvrepack' > $BUILD_DIR/.profile.d/tvrepack.sh

echo "-----> Done"
